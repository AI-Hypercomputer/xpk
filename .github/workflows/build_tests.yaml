# Copyright 2024 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      https://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License

name: Build Tests

on:
  workflow_dispatch:
    inputs:
      tpu-type:
        description: 'TPU Type'
        required: true
        default: 'v4-8'
        type: choice
        options:
          - v4-8
  push:
    branches: ["main"]
  pull_request: # By default this runs for types assigned, opened and synchronize.

env:
  # Names must be unique in parallel running tests.
  TPU_TYPE: ${{ inputs.tpu-type || 'v4-8' }}
  CLUSTER_NAME: build-xpk-2-nodepools-pr-${{ github.event.number}}
  GROUP_NAME: xpk-pr-${{ github.event.number}}
  ZONE: us-central2-a

jobs:
  linter:
    uses: ./.github/workflows/lint_and_format.yml
    with:
      group-name: $GROUP_NAME
  run-unit-tests:
    uses: ./.github/workflows/unit_tests.yaml
    with:
      group-name: $GROUP_NAME
    needs: [linter]
  run-integration-tests:
    uses: ./.github/workflows/integration_tests.yaml
    with:
      group-name: $GROUP_NAME
    secrets:
      gcp-sa-key: ${{secrets.GCP_SA_KEY}}
    needs: [run-unit-tests]
  cluster-create:
    needs: [run-integration-tests]
    uses: ./.github/workflows/cluster_create.yaml
    with:
      cluster-name: $CLUSTER_NAME
      tpu-type: $TPU_TYPE
      group-name: $GROUP_NAME
      zone: $ZONE
    secrets:
      gcp-sa-key: ${{secrets.GCP_SA_KEY}}
      network-name: ${{secrets.NETWORK_NAME}}
      subnetwork-name: ${{secrets.SUBNETWORK_NAME}}
      gcp-tpu-reservation: ${{secrets.GCP_TPU_V4_RESERVATION}}
  workloads-tests:
    needs: [cluster-create]
    uses: ./.github/workflows/workload_test.yaml
    with:
      group-name: $GROUP_NAME
      cluster-name: $CLUSTER_NAME
      tpu-type: $TPU_TYPE
      zone: $ZONE
    secrets:
      gcp-sa-key: ${{secrets.GCP_SA_KEY}}
  batch-tests:
    needs: [cluster-create]
    uses: ./.github/workflows/batch_test.yaml
    with:
      cluster-name: $CLUSTER_NAME
      group-name: $GROUP_NAME
      zone: $ZONE
    secrets:
      gcp-sa-key: ${{secrets.GCP_SA_KEY}}
  cluster-delete:
    if: always()
    needs: [workloads-tests, batch-tests]
    uses: ./.github/workflows/cluster_delete.yaml
    with:
      cluster-name: $CLUSTER_NAME
      zone: $ZONE
    secrets:
      gcp-sa-key: ${{secrets.GCP_SA_KEY}}




