# Copyright 2024 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      https://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License

name: Build Tests

on:
  workflow_dispatch:
    inputs:
      tpu-type:
        description: 'TPU Type'
        required: true
        default: 'v4-8'
        type: choice
        options:
          - v4-8
  push:
    branches: ["main"]
  pull_request: # By default this runs for types assigned, opened and synchronize.

env:
  # Names must be unique in parallel running tests.
  TPU_TYPE: ${{ inputs.tpu-type || 'v4-8' }}
  TPU_CLUSTER_NAME: build-xpk-2-nodepools
  WORKLOAD_NAME: xpktest-build-${{ github.run_attempt }}
  PATHWAYS_WORKLOAD_NAME: xpkpw-build-${{ github.run_attempt }}
  CLUSTER_ARGUMENTS: "--network=${{secrets.NETWORK_NAME}} --subnetwork=${{secrets.SUBNETWORK_NAME}} --maintenance-window=23:50"
  RUN_ID: "pr-${{ github.event.number }}"
  PROJECT_ID: ${{secrets.PROJECT_NAME}}
  A3_MEGA_TEST_CLUSTER_NAME: "xpk-mega-ctk-int"
  A3_ULTRA_TEST_CLUSTER_NAME: "xpk-ultra-ctk-int"
  GKE_ML_TEST_CLUSTER_NAME: "xpk-gke-ml"
  ZONE: us-central2-a
  REGION: us-central2

jobs:
  linter:
    uses: ./.github/workflows/lint_and_format.yml
    with:
      group-name: "foo"
  run-unit-tests:
    uses: ./.github/workflows/unit_tests.yaml
    with:
      group-name: "foo"
    needs: [linter]
  run-integration-tests:
    uses: ./.github/workflows/integration_tests.yaml
    with:
      group-name: "foo"
    needs: [run-unit-tests]
  cluster-create:
    needs: [run-integration-tests]
    with:
      cluster-name: $CLUSTER_NAME
      tpu-type: $TPU_TYPE
      group-name: $GROUP_NAME
      zone: $ZONE
    uses: ./.github/workflows/cluster_create.yaml
  workloads-tests:
    needs: [cluster-create]
    uses: ./.github/workflows/workload_test.yaml
    with:
      group-name: $GROUP_NAME
      cluster-name: $CLUSTER_NAME
      tpu-type: $TPU_TYPE
      zone: $ZONE
  batch-tests:
    needs: [cluster-create]
    uses: ./.github/workflows/batch_test.yaml
    with:
      cluster-name: $CLUSTER_NAME
      group-name: $GROUP_NAME
      zone: $ZONE
  cluster-delete:
    if: always()
    uses: ./.github/workflows/cluster_delete.yaml
    with:
      cluster-name: $CLUSTER_NAME
      zone: $ZONE




