# Copyright 2025 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      https://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License

name: Basic GPU cluster create

on:
    workflow_call:

permissions:
  contents: read

jobs:
    gpu-cluster-create-and-delete:
        runs-on: [ubuntu-22.04]
        concurrency:
            group: nightly-test-cluster-group-gpu
            cancel-in-progress: false
        env:
            GPU_CLUSTER_NAME: nightly-xpk-b200
            WORKLOAD_NAME: xpktest-gpu-nightly-${{ github.run_attempt }}
        steps:
            - uses: actions/download-artifact@v4
              with:
                  name: custom-scripts
            - name: Setup environment
              uses: ./.github/actions/setup-test-env
              with:
                  credentials_json: "${{ secrets.GCP_SA_KEY }}"
            - name: Check xpk installation
              run: xpk version
            - name: 'Setup Service Account for XPK'
              run: |
                # 1. Clear any existing WIF configurations to avoid conflicts
                rm -rf $HOME/.config/gcloud
                mkdir -p $HOME/.config/gcloud

                # 2. Write the Key File
                echo '${{ secrets.GCP_SA_KEY }}' > $HOME/.config/gcloud/application_default_credentials.json

                # 3. CRITICAL STEP: Activate the Service Account
                # This updates the internal config files to point to the key file.
                # When Docker mounts the directory, it will now see "Active Account: Service Account"
                gcloud auth activate-service-account --key-file=$HOME/.config/gcloud/application_default_credentials.json --project=cloud-tpu-multipod-dev

                # 4. Set Env Var for the host (GitHub Runner)
                echo "GOOGLE_APPLICATION_CREDENTIALS=$HOME/.config/gcloud/application_default_credentials.json" >> $GITHUB_ENV
            - name: Debug Permissions
              run: |
                echo "Using Service Account Key:"
                echo $GOOGLE_APPLICATION_CREDENTIALS

                # Activate the account on the runner to test it
                gcloud auth activate-service-account --key-file=$GOOGLE_APPLICATION_CREDENTIALS

                # Print the current identity
                echo "Authenticated as:"
                gcloud config get-value account

                # TEST 1: Can we see the project? (If this fails -> IAM Role 'Browser' or 'Viewer' missing)
                echo "Testing Project Access..."
                gcloud projects describe cloud-tpu-multipod-dev --format="value(lifecycleState)"

                # TEST 2: Can we check Service Usage? (If this fails -> 'Service Usage Consumer' missing)
                echo "Testing API Access..."
                gcloud services list --project=cloud-tpu-multipod-dev --limit=1
            - name: Create an XPK Cluster with 1 x b200 GPU
              run: xpk cluster create --cluster $GPU_CLUSTER_NAME --device-type=b200-8 --zone=asia-northeast1-b --default-pool-cpu-machine-type=n1-standard-16 --spot
            - name: Authenticate Docker
              run: gcloud auth configure-docker --quiet
            - name: Run a base-docker-image workload
              run: xpk workload create --cluster $GPU_CLUSTER_NAME --workload $WORKLOAD_NAME --docker-image='nvidia/cuda:12.1.0-base-ubuntu22.04' --command "nvidia-smi" --zone=asia-northeast1-b --device-type=b200-8
            - name: List out the workloads on the cluster
              run: xpk workload list --cluster $GPU_CLUSTER_NAME --zone=asia-northeast1-b
            - name: Wait for workload completion and confirm it succeeded
              run: xpk workload list --cluster $GPU_CLUSTER_NAME --zone=asia-northeast1-b --wait-for-job-completion $WORKLOAD_NAME --timeout 600
            - name: Delete the workload on the cluster
              run: xpk workload delete --workload $WORKLOAD_NAME --cluster $GPU_CLUSTER_NAME --zone=asia-northeast1-b
            - name: Delete the cluster created
              if: always()
              run: xpk cluster delete --cluster $GPU_CLUSTER_NAME --zone=asia-northeast1-b --force
            - name: Upload cluster nodepool creation log
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: gpu-cluster-nodepool-log-${{github.run_id}}
                  path: /tmp/NodepoolCreate-${{ env.GPU_CLUSTER_NAME }}-np-*
