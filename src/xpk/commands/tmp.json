{ 'spec': { 'parallelism': 2, 'completions': 2, 'backoffLimit': 0, 'podFailurePolicy': { 'rules': [{ 'action': 'FailJob', 'onExitCodes': { 'containerName': 'gpu-image', 'operator': 'NotIn', 'values': [42, 127, 128, 129, 130, 131, 132, 133, 134, 135, 136, 137, 138, 139, 140, 141, 142, 143, 144, 145, 146, 147, 148, 149, 150, 151, 152, 153, 154, 155, 156, 157, 158, 159, 160, 161, 162, 163, 164, 165, 166, 167, 168, 169, 170, 171, 172, 173, 174, 175, 176, 177, 178, 179, 180, 181, 182, 183, 184, 185, 186, 187, 188, 189, 190, 191, 192, 193, 194, 195, 196, 197, 198, 199, 200, 201, 202, 203, 204, 205, 206, 207, 208, 209, 210, 211, 212, 213, 214, 215, 216, 217, 218, 219, 220, 221, 222, 223, 224, 225, 226, 227, 228, 229, 230, 231, 232, 233, 234, 235, 236, 237, 238, 239, 240, 241, 242, 243, 244, 245, 246, 247, 248, 249, 250, 251, 252, 253, 254, 255] } }] }, 'template': { 'metadata': { 'labels': { 'xpk.google.com/workload': 'gcie-a3mega-4-wl-3' }, 'annotations': { 'kueue.x-k8s.io/podset-preferred-topology': 'cloud.google.com/gce-topology-host', 'devices.gke.io/container.tcpxo-daemon': '- path: /dev/nvidia0\n- path: /dev/nvidia1\n- path: /dev/nvidia2\n- path: /dev/nvidia3\n- path: /dev/nvidia4\n- path: /dev/nvidia5\n- path: /dev/nvidia6\n- path: /dev/nvidia7\n- path: /dev/nvidiactl\n- path: /dev/nvidia-uvm\n- path: /dev/dmabuf_import_helper\n', 'networking.gke.io/default-interface': 'eth0', 'networking.gke.io/interfaces': '[\n    {"interfaceName":"eth0","network":"default"},\n    {"interfaceName":"eth1","network":"gcie-a3mega-4-gpunet-0-subnet"},\n    {"interfaceName":"eth2","network":"gcie-a3mega-4-gpunet-1-subnet"},\n    {"interfaceName":"eth3","network":"gcie-a3mega-4-gpunet-2-subnet"},\n    {"interfaceName":"eth4","network":"gcie-a3mega-4-gpunet-3-subnet"},\n    {"interfaceName":"eth5","network":"gcie-a3mega-4-gpunet-4-subnet"},\n    {"interfaceName":"eth6","network":"gcie-a3mega-4-gpunet-5-subnet"},\n    {"interfaceName":"eth7","network":"gcie-a3mega-4-gpunet-6-subnet"},\n    {"interfaceName":"eth8","network":"gcie-a3mega-4-gpunet-7-subnet"}\n]' } }, 'spec': { 'priorityClassName': 'medium', 'restartPolicy': 'Never', 'dnsPolicy': 'ClusterFirstWithHostNet', 'terminationGracePeriodSeconds': 30, 'serviceAccountName': 'xpk-sa', 'tolerations': [{ 'operator': 'Exists', 'key': 'nvidia.com/gpu' }], 'volumes': None, 'containers': [{ 'name': 'gpu-image', 'image': 'us-docker.pkg.dev/gce-ai-infra/gpudirect-gib/nccl-plugin-gib-diagnostic:v1.0.3', 'imagePullPolicy': 'Always', 'env': [{ 'name': 'REPLICATED_JOB_NAME', 'valueFrom': { 'fieldRef': { 'fieldPath': "metadata.annotations['jobset.sigs.k8s.io/replicatedjob-name']" } } }, { 'name': 'JOBSET_NAME', 'valueFrom': { 'fieldRef': { 'fieldPath': "metadata.annotations['jobset.sigs.k8s.io/jobset-name']" } } }, { 'name': 'JAX_COORDINATOR_ADDRESS', 'value': '$(JOBSET_NAME)-$(REPLICATED_JOB_NAME)-0-0.$(JOBSET_NAME)' }, { 'name': 'NNODES', 'value': '2' }, { 'name': 'NODE_RANK', 'valueFrom': { 'fieldRef': { 'fieldPath': "metadata.annotations['batch.kubernetes.io/job-completion-index']" } } }, { 'name': 'USE_GPUDIRECT', 'value': 'tcpxo' }, { 'name': 'GPUS_PER_NODE', 'value': '8' }, { 'name': 'JAX_COORDINATOR_PORT', 'value': '6002' }, { 'name': 'COMMAND', 'value': 'bash workload.sh' }], 'ports': [{ 'containerPort': 6002 }], 'securityContext': { 'privileged': True }, 'command': ['bash', '-c', 'echo XPK Start: $(date);\n_sigterm() (kill -SIGTERM $! 2>/dev/null;);\ntrap _sigterm SIGTERM;\n\n(bash workload.sh) & PID=$!;\nwhile kill -0 $PID 2>/dev/null;\n    do sleep 5;\ndone;\nwait $PID;\nEXIT_CODE=$?;\n\necho XPK End: $(date);\necho EXIT_CODE=$EXIT_CODE;\n\necho Main app is done > /usr/share/workload/workload_terminated; \nexit $EXIT_CODE\n'], 'resources': { 'limits': { 'nvidia.com/gpu': 8 } } }] } } } }