# Copyright 2024 "Google LLC"
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
!CtkBlueprint
blueprint_name: xpk-gke-a3-ultra

vars:

deployment_groups:
- !CtkDeploymentGroup
  group: primary
  modules:
  - !CtkDeploymentModule
    id: gke-a3-ultra-net-0
    source: github.com/GoogleCloudPlatform/cluster-toolkit.git//modules/network/vpc?ref=e0c690b
    settings:
      network_name: gke-a3-ultra-net-0
      subnetworks:
      - subnet_name: gke-a3-ultra-sub-0
        subnet_region: us-central1
        subnet_ip: 192.168.0.0/18
      secondary_ranges:
        gke-a3-ultra-sub-0:
        - range_name: pods
          ip_cidr_range: 10.4.0.0/14
        - range_name: services
          ip_cidr_range: 10.0.32.0/20
      firewall_rules:
      - name: gke-a3-ultra-internal-0
        ranges: [192.168.0.0/16]
        allow:
        - protocol: tcp
          ports: ["0-65535"]
        - protocol: udp
          ports: ["0-65535"]
        - protocol: icmp

  - !CtkDeploymentModule
    id: gke-a3-ultra-net-1
    source: github.com/GoogleCloudPlatform/cluster-toolkit.git//modules/network/vpc?ref=e0c690b
    settings:
      network_name: gke-a3-ultra-net-1
      mtu: 8896
      subnetworks:
      - subnet_name: gke-a3-ultra-sub-1
        subnet_region: us-central1
        subnet_ip: 192.168.64.0/18
      firewall_rules:
      - name: gke-a3-ultra-internal-1
        ranges: [192.168.0.0/16]
        allow:
        - protocol: tcp
          ports: ["0-65535"]
        - protocol: udp
          ports: ["0-65535"]
        - protocol: icmp

  - !CtkDeploymentModule
    id: gke-a3-ultra-rdma-net
    source: github.com/GoogleCloudPlatform/cluster-toolkit.git//community/modules/network/rdma-vpc?ref=98c49fe
    settings:
      network_name: gke-a3-ultra-rdma-net
      mtu: 8896
      network_profile: https://www.googleapis.com/compute/beta/projects/foo/global/networkProfiles/us-central1-c-vpc-roce
      network_routing_mode: REGIONAL
      subnetworks_template:
        name_prefix: gke-a3-ultra-rdma-sub
        count: 8
        ip_range: 192.168.128.0/18
        region: us-central1

  - !CtkDeploymentModule
    id: a3-ultragpu-cluster
    source: github.com/GoogleCloudPlatform/cluster-toolkit.git//modules/scheduler/gke-cluster?ref=e0c690b
    use: [gke-a3-ultra-net-0]
    settings:
      min_master_version: "1.31.2-gke.1384000"
      system_node_pool_machine_type: "e2-standard-16"
      system_node_pool_disk_size_gb: 200
      system_node_pool_taints: []
      enable_dcgm_monitoring: true
      enable_gcsfuse_csi: true
      enable_private_endpoint: false # Allows access from authorized public IPs
      master_authorized_networks:
      - cidr_block: 10.0.0.0/32 # Allows your machine to run the kubectl command. Required for multi network setup.
        display_name: "kubectl-access-network"
      additional_networks: $(concat([{network=gke-a3-ultra-net-1.network_name, subnetwork=gke-a3-ultra-net-1.subnetwork_name, subnetwork_project=foo, nic_type="GVNIC", queue_count=null, network_ip=null, stack_type=null, access_config=[{nat_ip=null, public_ptr_domain_name=null, network_tier=null}], ipv6_access_config=[], alias_ip_range=[]}], gke-a3-ultra-rdma-net.subnetwork_interfaces_gke))
    outputs: [instructions]

  - !CtkDeploymentModule
    id: a3-ultragpu-pool
    source: github.com/GoogleCloudPlatform/cluster-toolkit.git//modules/compute/gke-node-pool?ref=e0c690b
    use: [a3-ultragpu-cluster]
    settings:
      machine_type: a3-ultragpu-8g
      zones: [us-central1-c]
      disk_type: hyperdisk-balanced
      disk_size_gb: 100
      static_node_count: 4
      guest_accelerator:
      - type: nvidia-h200-141gb
        count: 8
        gpu_driver_installation_config:
          gpu_driver_version: "LATEST"
      reservation_affinity:
        consume_reservation_type: SPECIFIC_RESERVATION
        specific_reservations:
        - name: foo
      additional_networks:
        $(concat([{network=gke-a3-ultra-net-1.network_name, subnetwork=gke-a3-ultra-net-1.subnetwork_name, subnetwork_project=foo, nic_type="GVNIC", queue_count=null, network_ip=null, stack_type=null, access_config=[{nat_ip=null, public_ptr_domain_name=null, network_tier=null}], ipv6_access_config=[], alias_ip_range=[]}], gke-a3-ultra-rdma-net.subnetwork_interfaces_gke))
    outputs: [instructions]

  - !CtkDeploymentModule
    id: topology-aware-scheduler-install
    source: github.com/GoogleCloudPlatform/cluster-toolkit.git//community/modules/compute/gke-topology-scheduler?ref=e0c690b
    use: [a3-ultragpu-cluster]

  - !CtkDeploymentModule
    id: workload-manager-install
    source: github.com/GoogleCloudPlatform/cluster-toolkit.git//modules/management/kubectl-apply?ref=e0c690b
    use: [a3-ultragpu-cluster]
    settings:
      kueue:
        install: true
        version: v0.9.1
      jobset:
        install: true
        version: v0.7.1
      apply_manifests:
      - source: $(ghpc_stage("./nccl-installer.yaml"))
      - source: $(ghpc_stage("./mglru-disable.yaml"))

  - !CtkDeploymentModule
    id: job-template
    source: modules/compute/gke-job-template
    use: [a3-ultragpu-pool]
    settings:
      image: nvidia/cuda:11.0.3-runtime-ubuntu20.04
      command:
      - nvidia-smi
      node_count: 2
      name: run-nvidia-smi
    outputs: [instructions]

# terraform_providers:
#   google:
#     source: hashicorp/google
#     version: 6.12.0
#     configuration:
#       project: foo
#       region: us-central1
#       zone: us-central1-c

#   # To use the 6.12.99 google-beta provider you must add the following to the
#   # ${HOME}/.terraformrc file (without comments):
#   #############################################################
#   # provider_installation {
#   #   network_mirror {
#   #     url = "https://storage.googleapis.com/a3u-beta-mirror/"
#   #     include = ["hashicorp/google-beta"]
#   #   }
#   # }
#   ##############################################################
#   google-beta:
#     source: hashicorp/google-beta
#     version: 6.12.99
#     configuration:
#       project: foo
#       region: us-central1
#       zone: us-central1-c